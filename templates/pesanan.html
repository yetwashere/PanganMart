<!doctype html>
<html lang="en">

<head>
    <!-- Required Meta Tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Favicon -->
    <link rel="icon" href="{{ url_for('static', filename='icon.png') }}" type="image/x-icon" />

    <!-- Bootstrap CSS (v5.3.3) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />

    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.js"
        integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>

    <!-- jQuery Cookie -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"
        integrity="sha512-3j3VU6WC5rPQB4Ld1jnLV7Kd5xr+cq9avvhwqzbH/taCRNURoeEpoPBK9pDyeukwSxwRPJ8fDgvYXd6SkaZ2TA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Bootstrap JS Bundle (v5.3.3) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://app.sandbox.midtrans.com/snap/snap.js" data-client-key="Mid-client-w3waOX5ZRCA3OB0t"></script>


    <title>WhyyyCatering - Pesanan Saya</title>
    <script>
        window.onload = function () {
            no_login();
            check_user();
        };
        function filterOrder(button, status) {
            // Hapus semua class 'active' di tombol filter
            $('#filter-buttons button').removeClass('active');

            // Tambahkan class 'active' hanya pada tombol yang diklik
            $(button).addClass('active');

            // Tampilkan pesanan sesuai filter
            showorder(status);
        }
        $(document).ready(function () {
            const defaultBtn = $('#filter-buttons button').first();
            defaultBtn.addClass('active');

            const defaultStatus = 'belum bayar';
            showorder(defaultStatus);
        });
    </script>

    <style>
        .custom-img-border {
            border: 3px solid #ccc;
            padding: 4px;
            border-radius: 12px;
        }

        /* Chat user di kanan */
        .chat-message.user {
            text-align: right;
            margin-left: auto;
        }

        .chat-message.user .bubble {
            background: linear-gradient(135deg, #33e3c2, #4bbdfd, #112978);
            color: white;
            border-bottom-right-radius: 0;
            padding: 10px 16px;
            border-radius: 18px;
            display: inline-block;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            position: relative;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .chat-message.user .timestamp {
            text-align: right;
        }

        /* Chat admin di kiri */
        .chat-message.admin {
            text-align: left;
            margin-right: auto;
        }

        .chat-message.admin .bubble {
            background: linear-gradient(135deg, #f1f3f5, #d8dde2);
            color: #333;
            border-bottom-left-radius: 0;
            padding: 10px 16px;
            border-radius: 18px;
            display: inline-block;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            position: relative;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .chat-message.admin .timestamp {
            text-align: left;
        }
    </style>
</head>

<body>
    <nav class="navbar fixed-top navbar-expand bg-nav">
        <div class="container-fluid">
            <a class="navbar-brand" href="#" onclick="check_role()">
                <img src="{{ url_for('static', filename='logonew.png') }}" alt="Logo"  width="100">
            </a>
            <div class="collapse navbar-collapse justify-content-end" id="navbarNavAltMarkup">
                <div class="navbar-nav">
                    <form class="d-flex">
                        <div class="form-control me-4 form-nav">
                            <input class="inp-nav" placeholder="Mencari Sesuatu?" aria-label="Search" id="cari">
                            <a onclick="cari()"><i class="fa fa-search fa-lg icon-src-nav" aria-hidden="true"></i></a>
                        </div>
                    </form>
                </div>
                <a href="/favorite"><i class="fa fa-heart fa-2x me-4" aria-hidden="true" style="color: white;"></i></a>
                <a href="/cart"><i class="fa fa-shopping-cart fa-2x me-4" aria-hidden="true"
                        style="color: white;"></i></a>
                <div class="dropdown">
                    <button onclick="toggleDropdown()" class="profile-btn">
                        <i class="fa fa-user fa-2x me-2" aria-hidden="true" style="color: bisque;"></i>
                    </button>
                    <div id="profileDropdown" class="dropdown-content">
                        <a href="/profile">Profil Saya</a>
                        <a href="/orders">Pesanan Saya</a>
                        <a href="#" onclick="sign_out()">Keluar</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container m-top-100">
        <div class="row justify-content-center">
            <h1 class="extrabold">Pesanan</h1>
            <div class="d-flex flex-wrap gap-2 mb-4 justify-content-center" id="filter-buttons">
                <button type="button" class="btn btn-outline-warning" onclick="filterOrder(this, 'belum bayar')">‚è≥ Belum
                    Bayar</button>
                <!-- <button type="button" class="btn btn-outline-primary"
                    onclick="filterOrder(this, 'menunggu pembayaran')">üí≥ Menunggu Pembayaran</button> -->
                <button type="button" class="btn btn-outline-info" onclick="filterOrder(this, 'sudah bayar')">‚úÖ Sudah
                    Bayar</button>
                <button type="button" class="btn btn-outline-success" onclick="filterOrder(this, 'terkirim')">üì¶
                    Terkirim</button>
                <button type="button" class="btn btn-outline-secondary"
                    onclick="filterOrder(this, 'pesanan selesai')">üìù Selesai</button>
                <button type="button" class="btn btn-outline-danger" onclick="filterOrder(this, 'dibatalkan')">‚ùå
                    Dibatalkan</button>
            </div>
        </div>
    </div>

    <div class="container mt-3 mb-5" id="showoderan"></div>

    <!-- Modal Konfirmasi Logout -->
    <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 shadow">
                <div class="modal-header">
                    <h5 class="modal-title fw-semibold" id="logoutModalLabel">Konfirmasi Logout</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
                </div>
                <div class="modal-body">
                    Apakah Anda yakin ingin keluar dari akun Anda?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-danger" onclick="confirm_logout()">Keluar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Verifikasi Wajah (Ukuran Kecil) -->
    <div id="faceModal" style="display: none;">
        <div class="modal-content11 shadow"
            style="max-width: 400px; margin: 5% auto; border-radius: 12px; background: #fff;">
            <!-- Header -->
            <div class="modal-header position-relative" style="padding: 10px 16px;">
                <h5 class="w-100 text-center m-0">Verifikasi Wajah</h5>
                <button type="button" class="btn-close position-absolute end-0 top-0 m-2"
                    onclick="closeFaceModal()"></button>
            </div>

            <!-- Area Kamera -->
            <div class="face-area d-flex justify-content-center px-3 pt-2 pb-1">
                <video id="video" autoplay playsinline
                    style="width: 100%; max-width: 100%; border-radius: 10px;"></video>
                <canvas id="face-capture" style="display: none;"></canvas>
            </div>

            <!-- Spinner + Progress -->
            <div class="modal-footer-custom text-center px-4 pb-3">
                <div id="spinner" class="text-muted small mb-2" style="display: none;">Mendeteksi wajah...</div>
                <progress id="progressBar" value="0" max="1" class="form-range w-100" style="height: 10px;"></progress>
            </div>
        </div>
    </div>


    <!-- Modal Live Chat -->
    <div class="modal fade" id="liveChatModal" tabindex="-1" aria-labelledby="liveChatModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content shadow rounded-4">
                <div class="modal-header text-white" style="background-color: #625f5f;">
                    <button type="button" class="btn text-white p-0 me-2" onclick="$('#liveChatModal').modal('hide')">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="flex-grow-1 text-center">
                        <strong>Live Chat</strong><br>
                        <small id="chatOrderId" class="text-white-50"></small>
                    </div>
                    <span style="width: 32px;"></span>
                </div>

                <div class="modal-body p-3" style="background-color: #f1f4f9;">
                    <div id="chatBox" class="chat-box border rounded-3 bg-white p-3"
                        style="height: 350px; overflow-y: auto;"></div>
                    <div class="d-flex mt-3">
                        <input type="text" id="chatMessage" class="form-control me-2" placeholder="Ketik pesan..."
                            onkeydown="if(event.key==='Enter') sendMessage()">
                        <button class="btn btn-info" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script defer src="{{ url_for('static', filename='js/myjs.js') }}"></script>

    <script>
        let currentOrderId = '';

        function openChat(orderid) {
            currentOrderId = orderid;
            document.getElementById('chatOrderId').innerText = `Order ID: ${orderid}`;
            $('#liveChatModal').modal('show');
            loadChat();
        }

        async function loadChat() {
            if (!currentOrderId) return;

            try {
                const res = await fetch(`/getchat?orderid=${currentOrderId}`);
                const data = await res.json();

                const chatBox = document.getElementById("chatBox");
                chatBox.innerHTML = '';

                if (data.result === 'success') {
                    const currentUser = getCookie('username');

                    data.chat.forEach(c => {
                        const roleClass = c.username === currentUser ? 'user' : 'admin';

                        chatBox.innerHTML += `
                <div class="chat-message ${roleClass}">
                    <div class="sender-name"><b>${c.username}</b></div>
                    <div class="bubble">${c.message}</div>
                    <div class="timestamp">${formatTime(c.timestamp)}</div>
                </div>`;
                    });

                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            } catch (err) {
                console.error("Gagal memuat chat:", err);
            }
        }

        async function sendMessage() {
            const pesan = document.getElementById("chatMessage").value.trim();
            if (!pesan || !currentOrderId) return;

            try {
                const res = await fetch('/sendchat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderid: currentOrderId, message: pesan })
                });

                const data = await res.json();
                if (data.result === 'success') {
                    document.getElementById("chatMessage").value = '';
                    loadChat();
                } else {
                    Swal.fire("Gagal", data.message || "Pesan gagal dikirim", "error");
                }
            } catch (err) {
                Swal.fire("Error", "Kesalahan saat mengirim pesan", "error");
            }
        }

        function getCookie(name) {
            let cookieArr = document.cookie.split(";");
            for (let i = 0; i < cookieArr.length; i++) {
                let cookiePair = cookieArr[i].split("=");
                if (name == cookiePair[0].trim()) {
                    return decodeURIComponent(cookiePair[1]);
                }
            }
            return null;
        }
    </script>

    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        AOS.init();
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.4/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.4/TextPlugin.min.js"></script>
    <script>
        gsap.registerPlugin(TextPlugin);
        gsap.from('.navbar', { duration: 1, y: '-100%', opacity: 0, ease: 'bounce' });
    </script>

</body>

</html>